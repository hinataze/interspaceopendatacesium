<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interspace Open Data (Cesium)</title>

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />

    <style>
      html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      /* Small control panel */
      #panel {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 9999;
        background: rgba(0,0,0,0.65);
        color: #fff;
        padding: 10px 12px;
        border-radius: 10px;
        font: 14px/1.3 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 320px;
      }
      #panel h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 6px 0;
      }
      .row input[type="checkbox"] { transform: scale(1.1); }
      .hint { opacity: 0.85; font-size: 12px; margin-top: 8px; }
      .btnrow { display:flex; gap:8px; margin-top: 10px; }
      button {
        cursor: pointer;
        border: 0;
        border-radius: 8px;
        padding: 8px 10px;
        font-weight: 600;
      }
      #status {
        margin-top: 8px;
        font-size: 12px;
        opacity: 0.9;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <div id="cesiumContainer"></div>

    <div id="panel">
      <h3>Datasets</h3>

      <div class="row">
        <input id="cb_parcels" type="checkbox" checked />
        <label for="cb_parcels">Parcels (GeoJSON)</label>
      </div>

      <div class="row">
        <input id="cb_4350872" type="checkbox" checked />
        <label for="cb_4350872">Point cloud 4350872</label>
      </div>

      <div class="row">
        <input id="cb_4350873" type="checkbox" checked />
        <label for="cb_4350873">Point cloud 4350873</label>
      </div>

      <div class="row">
        <input id="cb_4350865" type="checkbox" checked />
        <label for="cb_4350865">Point cloud 4350865</label>
      </div>

      <div class="row">
        <input id="cb_4350867" type="checkbox" checked />
        <label for="cb_4350867">Point cloud 4350867</label>
      </div>

      <div class="btnrow">
        <button id="btn_showall">Show all</button>
        <button id="btn_hideall">Hide all</button>
        <button id="btn_home">Focus</button>
      </div>

      <div class="hint">Tip: “Focus” flies to parcels extent (fallback: first loaded cloud).</div>
      <div id="status"></div>
    </div>

    <script>
      // Optional explicit server
      Cesium.Ion.defaultServer = "https://api.cesium.com/";
      Cesium.Ion.defaultAccessToken = "PASTE_YOUR_TOKEN_HERE";

      const statusEl = document.getElementById("status");
      const setStatus = (s) => { statusEl.textContent = s || ""; };

      const viewer = new Cesium.Viewer("cesiumContainer", {
        terrain: Cesium.Terrain.fromWorldTerrain(),
        animation: false,
        timeline: false,
        baseLayerPicker: false,
        geocoder: false,
        sceneModePicker: true,
        navigationHelpButton: false,
        infoBox: true,
        selectionIndicator: true,
      });

      // --- State holders ---
      let parcelsDataSource = null;
      const tilesets = new Map(); // assetId -> tileset instance

      // --- Helpers ---
      async function ensureParcelsLoaded() {
        if (parcelsDataSource) return parcelsDataSource;

        const parcelsAssetId = 1446854;
        setStatus("Loading parcels…");

        const resource = await Cesium.IonResource.fromAssetId(parcelsAssetId);
        const ds = await Cesium.GeoJsonDataSource.load(resource, { clampToGround: true });
        parcelsDataSource = ds;

        await viewer.dataSources.add(ds);

        // Style for visibility
        const ents = ds.entities.values;
        for (const e of ents) {
          if (e.polygon) {
            e.polygon.material = Cesium.Color.YELLOW.withAlpha(0.35);
            e.polygon.outline = true;
            e.polygon.outlineColor = Cesium.Color.BLACK;
            e.polygon.outlineWidth = 2;
          }
          if (e.polyline) {
            e.polyline.width = 3;
            e.polyline.material = Cesium.Color.YELLOW;
          }
          if (e.point) {
            e.point.pixelSize = 7;
            e.point.color = Cesium.Color.YELLOW;
          }
        }

        setStatus("");
        return ds;
      }

      function setParcelsVisible(visible) {
        if (!parcelsDataSource) return;
        const ents = parcelsDataSource.entities.values;
        for (const e of ents) {
          if (e.polygon) e.polygon.show = visible;
          if (e.polyline) e.polyline.show = visible;
          if (e.point) e.point.show = visible;
        }
      }

      async function ensureTilesetLoaded(assetId) {
        if (tilesets.has(assetId)) return tilesets.get(assetId);

        setStatus(`Loading point cloud ${assetId}…`);
        const ts = await Cesium.Cesium3DTileset.fromIonAssetId(assetId);
        viewer.scene.primitives.add(ts);
        await ts.readyPromise;

        tilesets.set(assetId, ts);
        setStatus("");
        return ts;
      }

      function setTilesetVisible(assetId, visible) {
        const ts = tilesets.get(assetId);
        if (ts) ts.show = visible;
      }

      async function focus() {
        // Prefer focusing parcels extent (nice stable camera target)
        if (document.getElementById("cb_parcels").checked) {
          const ds = parcelsDataSource || (await ensureParcelsLoaded());
          const ents = ds.entities.values;

          // Compute rectangle bounds (reliable)
          const time = Cesium.JulianDate.now();
          let rect = null;
          for (const e of ents) {
            if (e.polygon && e.polygon.hierarchy) {
              const h = e.polygon.hierarchy.getValue(time);
              if (h?.positions?.length) {
                const r2 = Cesium.Rectangle.fromCartesianArray(h.positions);
                rect = rect ? Cesium.Rectangle.union(rect, r2, rect) : r2;
              }
            }
          }
          if (rect) {
            const pad = Cesium.Math.toRadians(0.001);
            const padded = new Cesium.Rectangle(
              rect.west - pad, rect.south - pad, rect.east + pad, rect.north + pad
            );
            viewer.camera.flyTo({ destination: padded, duration: 0.0 });
            return;
          }
        }

        // Fallback: focus first visible tileset
        for (const [id, ts] of tilesets.entries()) {
          if (ts.show) {
            await viewer.zoomTo(ts, new Cesium.HeadingPitchRange(0, -0.6, 80));
            return;
          }
        }
      }

      // --- Wire up UI ---
      async function onToggleParcels() {
        const checked = document.getElementById("cb_parcels").checked;
        if (checked) {
          await ensureParcelsLoaded();
          setParcelsVisible(true);
        } else {
          setParcelsVisible(false);
        }
      }

      async function onToggleCloud(assetId) {
        const cb = document.getElementById(`cb_${assetId}`);
        const checked = cb.checked;

        if (checked) {
          const ts = await ensureTilesetLoaded(assetId);
          ts.show = true;
        } else {
          setTilesetVisible(assetId, false);
        }
      }

      document.getElementById("cb_parcels").addEventListener("change", onToggleParcels);

      const cloudIds = [4350872, 4350873, 4350865, 4350867];
      for (const id of cloudIds) {
        document.getElementById(`cb_${id}`).addEventListener("change", () => onToggleCloud(id));
      }

      document.getElementById("btn_showall").addEventListener("click", async () => {
        document.getElementById("cb_parcels").checked = true;
        await onToggleParcels();

        for (const id of cloudIds) {
          document.getElementById(`cb_${id}`).checked = true;
          await onToggleCloud(id);
        }
      });

      document.getElementById("btn_hideall").addEventListener("click", async () => {
        document.getElementById("cb_parcels").checked = false;
        await onToggleParcels();

        for (const id of cloudIds) {
          document.getElementById(`cb_${id}`).checked = false;
          await onToggleCloud(id);
        }
      });

      document.getElementById("btn_home").addEventListener("click", focus);

      // --- Initial load: match default checkbox state ---
      (async () => {
        try {
          // Load parcels if checked
          if (document.getElementById("cb_parcels").checked) {
            await ensureParcelsLoaded();
          }

          // Load clouds that are checked
          for (const id of cloudIds) {
            if (document.getElementById(`cb_${id}`).checked) {
              const ts = await ensureTilesetLoaded(id);
              ts.show = true;
            }
          }

          // Focus on startup
          await new Promise(r => setTimeout(r, 200));
          await focus();

          // Make Home button do the same as Focus
          viewer.homeButton.viewModel.command.beforeExecute.addEventListener((e) => {
            e.cancel = true;
            focus();
          });

        } catch (err) {
          console.error(err);
          document.body.innerHTML =
            "<pre style='white-space:pre-wrap;font-size:14px;padding:20px'>" +
            (err?.stack || err?.message || err) + "</pre>";
        }
      })();
    </script>
  </body>
</html>
