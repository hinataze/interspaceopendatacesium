<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cesium Debug</title>

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />

    <style>
      html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
      #dbg {
        position:absolute; top:10px; left:10px; z-index:9999;
        max-width: 420px;
        background: rgba(0,0,0,0.75); color:#fff; padding:10px 12px;
        border-radius:10px; font: 12px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <div id="cesiumContainer"></div>
    <div id="dbg">Starting…</div>

    <script>
      const dbg = (msg) => {
        const el = document.getElementById("dbg");
        el.textContent += "\n" + msg;
      };

      Cesium.Ion.defaultServer = "https://api.cesium.com/";
      Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxYThlNWVlZS1lZjMwLTQwMTUtOThjNy1mYWI5ZTNlMTg1M2IiLCJpZCI6MTE3NDExLCJpYXQiOjE3NjgzNzQ1OTF9.Gg3i6Lh85yI9VNGAwtDThAJUbZKwXvAztVEiM1h3vjw";

      (async () => {
        try {
          dbg("Token length: " + (Cesium.Ion.defaultAccessToken || "").length);

          // 1) Directly test ion endpoint (this is what CesiumJS calls internally)
          const testAssetId = 1446854;
          const url =
            `https://api.cesium.com/v1/assets/${testAssetId}/endpoint?access_token=` +
            encodeURIComponent(Cesium.Ion.defaultAccessToken);

          const r = await fetch(url, { method: "GET" });
          dbg("Ion endpoint HTTP: " + r.status);

          const text = await r.text();
          dbg("Ion endpoint body (first 300 chars):\n" + text.slice(0, 300));

          if (!r.ok) {
            dbg("\nSTOP: ion rejected the token or asset access. Fix token/scopes/resources.");
            return;
          }

          // 2) If ion endpoint test passes, proceed to load normally
          const viewer = new Cesium.Viewer("cesiumContainer", {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            animation: false,
            timeline: false,
            baseLayerPicker: false,
            geocoder: false,
            sceneModePicker: true,
            navigationHelpButton: false,
          });

          const resource = await Cesium.IonResource.fromAssetId(testAssetId);
          const ds = await Cesium.GeoJsonDataSource.load(resource, { clampToGround: true });
          await viewer.dataSources.add(ds);
          await viewer.zoomTo(ds);

          dbg("\nLoaded GeoJSON OK ✅");
        } catch (e) {
          dbg("\nException:\n" + (e?.stack || e?.message || e));
        }
      })();
    </script>
  </body>
</html>
